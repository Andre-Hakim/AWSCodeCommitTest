# Working on wp-base in this version
on: push
name: Publish Website
jobs:
  web-deploy:
    name: ðŸš€ Deploy To AWS
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Parse .env file
      run: while read line; do echo $line >> $GITHUB_ENV; done < ./.env
    - name: Install SSH Key
      uses: shimataro/ssh-key-action@v2.3.0 
      with: 
        key: ${{ secrets.SSH_KEY_AWS_TEST }}
        known_hosts: 'foo'
    - name: Adding Known Hosts
      run: ssh-keyscan -H ${{ secrets.PUBLICIP }} >> ~/.ssh/known_hosts
    - name: List Contents
      run: ls -l ./
    - name: npm Install
      working-directory: ./TestDir2
      run: npm install
    - name: gulp
      working-directory: ./TestDir2
      run: gulp compile
    - name: Docker up command
      uses: tj-actions/verify-changed-files@v8
      id: verify-changed-files
      with:
        files: |
             ./testChange.txt
    - name: Display changed files
      if: steps.verify-changed-files.outputs.files_changed == 'true'
      run: |
        echo "Changed files: ${{ steps.verify-changed-files.outputs.files_changed}}"
    - name: Deploy with rsync
      run: rsync --filter=':- .gitignore' -ravz --delete ./TestDir2/public ec2-user@${{ secrets.PUBLICIP }}:/home/ec2-user/testAux/
    - name: Spitting out Env file
      run: echo ${{ env.PROJECT_NAME }}

    # - name: ðŸ“‚ Sync files
    #   uses: ./
    #   with:
    #     target-server: ${{ secrets.PUBLICIP }}
    #     remote-user: ec2-user
    #     remote-key: ${{ secrets.SSH_KEY_AWS_TEST }}
    #     source-path: ./AWSUploadTest
    #     destination-path: ./home/ec2-user/home
    #     rsync-options: --stats